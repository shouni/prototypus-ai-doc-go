# ✍️ Prototypus AI Doc Go

[![Language](https://img.shields.io/badge/Language-Go-blue)](https://golang.org/)
[![Go Version](https://img.shields.io/github/go-mod/go-version/shouni/prototypus-ai-doc-go)](https://golang.org/)
[![GitHub tag (latest by date)](https://img.shields.io/github/v/tag/shouni/prototypus-ai-doc-go)](https://github.com/shouni/prototypus-ai-doc-go/tags)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## 💡 概要 (About)— **堅牢なGo並列処理とAIを統合した次世代ドキュメント音声化パイプライン**

**Prototypus AI Doc Go (PAID Go)** は、独自の **Gemini API クライアントライブラリ** ([`shouni/go-ai-client`](https://github.com/shouni/go-ai-client)) と **Go言語の強力な並列制御**を融合させた、**業界最高水準の堅牢性**を持つ高生産性 CLI ツールです。

長文の技術ドキュメントや記事を、AIが話者とスタイルを明確に指示した**対話形式やモノローグ形式のナレーションスクリプト**に変換するだけでなく、その台本をローカルの **VOICEVOXエンジンに高速接続**し、**最終的な音声ファイル (WAV)** まで自動で生成する**統合パイプライン**を提供します。

このツールは、単なるスクリプト生成を超え、Go言語の**堅牢な並列制御とデータ整合性チェック**により、コンテンツ制作の全工程を自動化し、開発チームのドキュメント配信パイプラインに革新をもたらします。

### 🌸 導入がもたらすポジティブな変化

| メリット | チームへの影響 | 期待される効果 |
| :--- | :--- | :--- |
| **AIによる台本自動生成** | **「文章化の最初の壁」が解消します。** AIが複雑なドキュメントの校正やナレーション形式への変換を担うため、**コンテンツクリエイターはアイデア出しと最終調整**に集中できます。 | 文章校正や推敲にかかる時間が**最大80%短縮**され、コンテンツ制作のサイクルが劇的に加速します。 |
| **超高速・安定した音声合成** | **「バッチ処理の失敗」や「結合の不整合」の心配が不要です。** Go言語の**堅牢な並列処理とリトライロジック**により、長文（数十分規模）の音声合成も高速かつ高確率で成功します。 | 処理の**安定性が保証**され、大規模なドキュメントの音声コンテンツ化における**技術的な労力とストレス**から解放されます。 |
| **明確なキャラクター指示** | **「音質のバラつき」や「話者不明」がなくなります。** AIが生成するスクリプトは、**許可された5種類のスタイルタグ**と話者をマークダウンで明確に指示するため、音声コンテンツの**品質と統一性**を自動で確保します。 | **音声コンテンツのブランドイメージ**が向上し、聞く人にとっての**理解度と快適性**が高まります。 |
| **統合パイプラインの提供** | **「複数ツールの連携」という間接作業が不要です。** スクリプト生成から最終的なWAVファイル出力までを一つのCLIコマンドで完結させる**統合パイプライン**を提供します。 | **制作の全工程が自動化**され、開発者はドキュメント配信をストレスフリーで行えるようになります。 |

-----

## ✨ 技術スタック (Technology Stack)

| 要素 | 技術 / ライブラリ | 役割 |
| :--- | :--- | :--- |
| **言語** | **Go (Golang)** | ツールの開発言語。クロスプラットフォームでの高速な実行を実現します。 |
| **並行処理** | **Goroutines (`sync` パッケージ)** | 複数の音声合成リクエストを**並列**で実行し、ネットワーク待ち時間や合成処理にかかる時間を短縮します。 |
| **CLI フレームワーク** | **Cobra** | コマンドライン引数（フラグ）やサブコマンド構造の構築に使用します。 |
| **AI モデル** | **Google Gemini API** | 入力された文章を分析し、指定された形式のナレーションスクリプトを生成するために使用します。 |
| **プロンプト管理** | **`//go:embed`** | プロンプトテンプレートをビルド時に実行ファイル内に埋め込み、管理を容易にします。 |
| **APIクライアント** | **カスタムHTTPクライアント** (`shouni/go-web-exact`) | Gemini API、VOICEVOX API、および外部POST APIとの通信に使用します。 |

-----

## 🛠️ 独自のネットワーククライアントによる堅牢化

本ツールは、**Webコンテンツの取得、VOICEVOX連携、外部API投稿**を含むすべてのネットワーク通信の堅牢性を確保するため、開発者が独自に設計・実装した**高信頼性HTTPクライアントライブラリ** ([`shouni/go-web-exact`](https://github.com/shouni/go-web-exact)) を使用しています。

### 1\. Webコンテンツ抽出と通信の分離

Webコンテンツの抽出（`goquery`ベースの処理）と、実際のHTTP通信処理を完全に分離し、`GenerateHandler`に依存性注入（DI）することで、コードの保守性とテスト容易性を高めています。

### 2\. 堅牢な自動リトライとタイムアウト制御

* **専用クライアントによる全通信の堅牢化**: すべてのWeb取得リクエストおよびVOICEVOX APIリクエストは、共通の**DI対応クライアント**によって処理されます。
* **指数バックオフリトライ**: ネットワークエラーやサーバーの一時的な負荷増大（5xx系エラーなど）が発生した場合、**指数バックオフ戦略**に基づいて自動的にリトライを実行します。これにより、大規模なドキュメントの取得・合成時の堅牢性が飛躍的に向上しています。
* **ユーザー定義可能なタイムアウト**: `--http-timeout` フラグにより、**すべての**Webリクエストの全体的なタイムアウト時間をユーザーが柔軟に設定可能です。

### 3\. 高度なWebコンテンツ特定ロジック (`go-web-exact` 内部)

* **インテリジェントな本文特定**: 主要なCMSやブログ構造に対応するため、複数のセレクタを組み合わせたロジックで本文エリアを特定します。
* **ノイズ要素の自動除去**: 広告、ソーシャルシェアボタン、コメント欄など、記事本文と無関係な要素を自動で除去します。

-----

## 🛡️ VOICEVOX連携の堅牢性

VOICEVOX連携機能は、長文のスクリプトを高速かつ安定して音声化するために、Go言語の強力な並列処理とVOICEVOX特有の緻密なエラーハンドリングを組み合わせています。

### 1\. 超高速な並列処理 (High-Speed Parallel Processing)

長大なスクリプトは数十から数百の**セグメント**（短い文）に分割され、各セグメントの音声合成リクエストは、**GoのGoroutine**を用いて並列に処理されます。

* **技術詳細**:
    * Goroutineを活用し、各セグメントの `audio_query` (音声クエリ) および `synthesis` (合成) API呼び出しを独立して実行します。
    * VOICEVOXエンジンへの過負荷を防ぐため、**最大並列実行数（デフォルト6セグメント）を厳密に制御**します。
    * これにより、ネットワークI/O待ち時間やVOICEVOXエンジン側の処理キュー待機時間を効率的に埋め合わせ、**逐次処理と比較して合成時間を劇的に短縮**します。
    * 合成が完了したWAVデータは、並列処理の完了後、`bytes.Buffer` を介して正確な順番で結合され、単一のファイルとして出力されます。

### 2\. 高安定性のための堅牢な通信設計 (Reliable Communication Design)

VOICEVOXエンジンへの通信は、前述の**DI対応の高信頼性HTTPクライアント**に完全に委譲されています。

* **技術詳細**:
    * **通信ロジックは、並列処理を行うエンジンコードから完全に分離**され、独立したDI対応クライアントに委譲されています。
    * **データ整合性の検証と早期エラー検出**: `audio_query` の応答に必須フィールドが欠落している場合、即座に処理を中断し、合成API (`synthesis`) での**不正なデータによる 422 エラー**を防ぎます。
    * このクライアントは、一時的なエンジンの負荷集中によるタイムアウトやエラーが発生した場合、**指数バックオフ戦略による自動リトライ**と十分な処理時間（最大5分）を内部で確保し、音声合成の成功率を極めて高い水準に維持します。

### 3\. スタイルIDの自動フォールバック (Automatic Style ID Fallback)

AIモデルの出力形式がプロンプトの指示からわずかに逸脱し、VOICEVOXがサポートしないタグが生成された場合でも、処理を中断させません。

* **技術詳細**:
    * `internal/voicevox` パッケージ内のマッピングロジックにおいて、AIが生成した**サポート対象外のスタイルタグ**（例：`[ずんだもん][納得]` や `[めたん][ツンツン]`）に対応する `Style ID` が見つからない場合、自動でその話者の**デフォルトスタイル**（`[話者タグ][ノーマル]`）の `Style ID` に切り替えます。
    * これにより、AI出力の軽微なフォーマットミスによってCLIの処理が中断することを防ぎ、音声ファイルの生成を確実に完了させます。

-----

## ✨ 主な機能

1.  **Webコンテンツからの自動抽出**: `--script-url (-u)` フラグにより、URLを指定するだけで、**記事タイトルと本文を自動で取得・整形し、AIに渡します**。
2.  **AIによる自動スクリプト生成**: 長文を **`solo`** (モノローグ/デフォルト)、**`dialogue`** (対話)、**`duet`** (交互ナレーション) の**3つの形式**に変換します。
3.  **VOICEVOX連携**: 生成されたスクリプトをローカルで起動しているVOICEVOXエンジンに送信し、**ゴルーチンによる並列処理**で高速に合成を行い、**連結された一つのWAV音声ファイル**として出力できます。
4.  **堅牢な処理**: 上記の**リトライ**、**不正データ検出**、および**フォールバック**ロジックにより、並列処理環境での安定した音声ファイル生成を実現します。
5.  **柔軟なI/O**: **Web (URL)**、**ファイル**、**標準入力**からの入力、およびファイル出力、標準出力、外部APIへの投稿に対応しています。

-----

## 📦 使い方

### 1\. 環境設定

ツールを実行する前に、以下の環境変数を設定してください。

| 変数名 | 必須/任意 | 説明 |
| :--- | :--- | :--- |
| `GEMINI_API_KEY` | 必須 | Google AI Studio で取得した Gemini API キー。 |
| `VOICEVOX_API_URL` | VOICEVOX使用時必須 | ローカルで起動しているVOICEVOXエンジンのURL。 (例: `http://localhost:50021`) |
| `POST_API_URL` | 外部API投稿時必須 | スクリプトを投稿する外部APIのエンドポイント。 |

### 2\. スクリプト生成コマンド

メインコマンドは `generate` です。

```bash
prototypus-ai-doc generate [flags]
```

#### フラグ一覧

入力ソースは **`--script-url`, `--script-file` のいずれか一つのみ**指定可能です。

| フラグ | 短縮形  | 説明 |
| :--- |:-----| :--- |
| `--script-url` | `-u` | **入力ソースURL**。Webページから記事本文を抽出し、AIに渡します。 |
| `--script-file` | `-f` | **入力スクリプトファイルのパス**。`'-'` を指定すると標準入力から読み込みます。 |
| `--output-file` | `-o` | 生成されたスクリプトを保存するファイル名。省略時は標準出力に出力。 |
| `--mode` | `-m` | スクリプトの形式: **`solo`** (モノローグ/デフォルト), **`dialogue`** (対話), **`duet`** (交互ナレーション)。**(Default: `duet`)** |
| `--voicevox` | `-v` | 生成されたスクリプトをVOICEVOXで合成し、指定されたファイル名 (`.wav`) で保存します。**他の出力フラグと同時に指定できません。** |
| `--post-api` | `-p` | 生成されたスクリプトを `POST_API_URL` に投稿します。 |
| `--http-timeout` | (なし) | **Webリクエストのタイムアウト時間**を設定します (例: `15s`, `1m`)。**(Default: 30s)** |

-----

## 🔊 実行例

### 例 1: Web記事を対話スクリプト化し、音声ファイルに出力（タイムアウト指定あり）

VOICEVOXエンジンと環境変数が設定済みであることを前提とします。

```bash
# Web上の技術記事を読み込み、対話モードでスクリプト生成、VOICEVOXの処理時間を考慮しタイムアウトを延長
./bin/prototypus-ai-doc generate \
    --script-url "https://github.com/shouni/prototypus-ai-doc-go" \
    --mode dialogue \
    --http-timeout 280s \
    --voicevox out_dialogue.wav
```

### 例 2: ローカルファイルをモノローグ化し、結果を画面に出力

```bash
# README.md の内容を元にモノローグスクリプトを生成し、標準出力に表示
./bin/prototypus-ai-doc generate \
    --script-file README.md \
    --mode solo \
    --output-file -  # 標準出力への明示的な指定 (省略可能)
```

### 例 3: 標準入力 (パイプ) から読み込み、外部APIに投稿（APIキーを直接指定）

```bash
# cat コマンドの出力をパイプで渡し、生成したスクリプトを外部APIに POST
cat my_draft.txt | ./bin/prototypus-ai-doc generate \
    --script-file - \
    --mode duet \
    --post-api
```

-----

### 📜 ライセンス (License)

このプロジェクトは [MIT License](https://opensource.org/licenses/MIT) の下で公開されています。
