# ✍️ Prototypus AI Doc Go

[![Language](https://img.shields.io/badge/Language-Go-blue)](https://golang.org/)
[![Go Version](https://img.shields.io/github/go-mod/go-version/shouni/git-gemini-reviewer-go)](https://golang.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)


## 💡 概要 (About)— AI駆動のドキュメント音声化パイプライン

**Prototypus AI Doc Go (PAID Go)** は、Google Gemini API を活用し、開発ドキュメントや技術記事などの長文を、対話形式またはモノローグ形式のナレーションスクリプトに変換する高生産性 CLI ツールです。

### 🚀 開発チームの生産性を劇的に向上

このツールは、単なるスクリプト生成に留まらず、生成した台本を**VOICEVOXエンジンに高速接続し、最終的な音声ファイル（WAV）まで自動生成する統合パイプライン**を提供します。

この機能拡張により、コンテンツクリエイターやチームは、以下の点で生産性を飛躍的に向上させます。

1.  **AIによる台本自動生成**: 文章校正や推敲にかかる時間を短縮し、**コンテンツ制作の最初の壁**を打ち破ります。
2.  **超高速・安定した音声合成**: Go言語の**堅牢な並列処理ロジック**により、長文のバッチ合成を高速かつ高安定で自動実行。**技術的な壁**を解消します。
3.  **明確なキャラクター指示**: AIが生成するスクリプトは、**話者（ずんだもん/めたん）やVOICEVOX標準スタイル**がマークダウンで明確に示され、音声合成の品質と統一性を確保します。

PAID Go を導入することで、大規模なドキュメントの音声コンテンツ化が**劇的にスピードアップし、開発者はコンテンツ制作の労力から解放されます。**

-----

## ✨ 技術スタック (Technology Stack)

| 要素 | 技術 / ライブラリ | 役割 |
| :--- | :--- | :--- |
| **言語** | **Go (Golang)** | ツールの開発言語。クロスプラットフォームでの高速な実行を実現します。 |
| **並行処理** | **Goroutines (`sync` パッケージ)** | 複数の音声合成リクエストを**並列**で実行し、ネットワーク待ち時間や合成処理にかかる時間を短縮します。 |
| **CLI フレームワーク** | **Cobra** | コマンドライン引数（フラグ）やサブコマンド構造の構築に使用します。 |
| **AI モデル** | **Google Gemini API** | 入力された文章を分析し、指定された形式のナレーションスクリプトを生成するために使用します。 |
| **プロンプト管理** | **`//go:embed`** | プロンプトテンプレートをビルド時に実行ファイル内に埋め込み、管理を容易にします。 |
| **APIクライアント** | 標準 `net/http` | Gemini API、VOICEVOX API、および外部POST APIとの通信に使用します。 |

-----

## 🛡️ VOICEVOX連携の堅牢性

VOICEVOX連携機能は、長文のスクリプトを高速かつ安定して音声化するために、Go言語の強力な機能と緻密なエラーハンドリングを組み合わせています。

### 1\. 超高速な並列処理 (High-Speed Parallel Processing)

長大なスクリプトは数十から数百の\*\*セグメント（短い文）\*\*に分割され、各セグメントの音声合成リクエストは、**GoのGoroutine**を用いて並列に処理されます。

* **技術詳細**:
    * Goroutineを活用し、各セグメントの `audio_query` (音声クエリ) および `synthesis` (合成) API呼び出しを独立して実行します。
    * これにより、ネットワークI/O待ち時間やVOICEVOXエンジン側の処理キュー待機時間を効率的に埋め合わせ、**逐次処理と比較して合成時間を劇的に短縮**します。
    * 合成が完了したWAVデータは、並列処理の完了後、`bytes.Buffer` を介して正確な順番で結合され、単一のファイルとして出力されます。

### 2\. 高安定性のためのリトライ処理 (Reliable Retry Logic)

VOICEVOXエンジンに短時間に大量のリクエストが集中した場合や、一時的なネットワーク負荷増大が発生した場合に備え、堅牢なリトライ機構を実装しています。

* **技術詳細**:
    * 並列実行中にセグメントごとの合成リクエストがタイムアウトやエラー（例：`context deadline exceeded`）を検出した場合、**指数バックオフ（Exponential Backoff）に近い戦略で処理を最大3回自動リトライ**します。
    * これにより、一時的なエンジンの負荷集中による失敗を吸収し、ユーザーが手動で再実行することなく、大規模なスクリプト全体の**音声合成成功率**を極めて高い水準に維持します。
    * リトライ間隔は徐々に延長されるため、エンジンへの更なる過負荷を避ける設計になっています。

### 3\. スタイルIDの自動フォールバック (Automatic Style ID Fallback)

AIモデルの出力形式がプロンプトの指示からわずかに逸脱し、VOICEVOXがサポートしないタグが生成された場合でも、処理を中断させません。

* **技術詳細**:
    * `internal/voicevox` パッケージ内のマッピングロジックにおいて、AIが生成した話者・トーンタグ（例：`[ずんだもん][納得]`）に対応する `Style ID` が見つからない場合、自動でその話者の\*\*デフォルトのトーン（`[話者タグ][ノーマル]`）\*\*の `Style ID` に切り替えます。
    * これにより、AI出力の軽微なフォーマットミス（例：`[ずんだもん][ずんだ]`, `[めたん][驚き]`）によってCLIの処理が中断することを防ぎ、音声ファイルの生成を確実に完了させます。

-----

## ✨ 主な機能

1.  **AIによる自動スクリプト生成**: 長文を **`solo`** (モノローグ)、**`dialogue`** (対話)、**`duet`** (交互ナレーション) の**3つの形式**に変換します。
2.  **VOICEVOX連携**: 生成されたスクリプトをローカルで起動しているVOICEVOXエンジンに送信し、**ゴルーチンによる並列処理**で高速に合成を行い、**連結された一つのWAV音声ファイル**として出力できます。
3.  **堅牢な処理**: 上記の**リトライ**および**フォールバック**ロジックにより、並列処理環境での安定した音声ファイル生成を実現します。
4.  **柔軟なI/O**: ファイル入力/出力、標準入力/出力、そして外部APIへの投稿に対応しています。
5.  **高い保守性**: Goのベストプラクティスに基づき、AI、I/O、VOICEVOX処理などのロジックが `internal` パッケージに分離されています。

-----

## 📦 使い方

### 1\. 環境設定

ツールを実行する前に、以下の環境変数を設定してください。

| 変数名 | 必須/任意 | 説明 |
| :--- | :--- | :--- |
| `GEMINI_API_KEY` | 必須 | Google AI Studio で取得した Gemini API キー。 |
| `VOICEVOX_API_URL` | VOICEVOX使用時必須 | ローカルで起動しているVOICEVOXエンジンのURL。 (例: `http://localhost:50021`) |
| `POST_API_URL` | 外部API投稿時必須 | スクリプトを投稿する外部APIのエンドポイント。 |

### 2\. スクリプト生成コマンド

メインコマンドは `generate` です。

```bash
prototypus-ai-doc generate [flags]
````

#### フラグ一覧

| フラグ | 短縮形 | 説明 |
| :--- | :--- | :--- |
| `--input-file` | `-i` | 元となる文章ファイル (`.txt` や `.md`) のパス。省略時は標準入力を使用。 |
| `--output-file` | `-o` | 生成されたスクリプトを保存するファイル名。省略時は標準出力に出力。 |
| `--mode` | `-m` | スクリプトの形式: **`solo`** (モノローグ/デフォルト), **`dialogue`** (対話), **`duet`** (交互ナレーション)。**(Default: `solo`)** |
| `--voicevox` | `-v` | 生成されたスクリプトをVOICEVOXで合成し、指定されたファイル名 (`.wav`) で保存します。**他の出力フラグと同時に指定できません。** |
| `--post-api` | `-p` | 生成されたスクリプトを `POST_API_URL` に投稿します。 |

-----

## 🔊 VOICEVOX連携の実行例

### 目的: この `README.md` を入力として使用し、対話スクリプトを生成、そして音声化する。

まず、この README ファイルを `README.md` として保存されていると仮定します。

#### 1\. VOICEVOXエンジンを起動し、環境変数を設定

```bash
# VOICEVOXを起動後、URLを設定
export VOICEVOX_API_URL="http://localhost:50021"
export GEMINI_API_KEY="AIzaSy...your-key...021"
```

#### 2\. コマンド実行

**入力ファイル (`-i`)** として自身の `README.md` を指定し、**VOICEVOX出力 (`-v`)** を `readme_audio.wav` に指定します。モードのデフォルトは `solo` ですが、例として `duet` を使用します。

```bash
# README.md の内容を元に対話スクリプトを生成し、WAVファイルを出力
./bin/prototypus-ai-doc generate \
    -i README.md \
    -m duet \
    -v readme_audio.wav
```

#### 実行結果 (ターミナル出力)

```
ファイルから読み込み中: README.md
--- 処理開始 ---
モード: duet
モデル: gemini-2.5-flash
...（入力サイズなどの情報）...

AIによるスクリプト生成を開始します...

VOICEVOXエンジンに接続し、音声合成を並列で開始します (出力: readme_audio.wav)...
VOICEVOXによる音声合成が完了し、ファイルに保存されました。

# 現在のディレクトリに readme_audio.wav が生成されます。
```

-----

### 📜 ライセンス (License)

このプロジェクトは [MIT License](https://opensource.org/licenses/MIT) の下で公開されています。