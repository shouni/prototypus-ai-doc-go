# ✍️ prototypus-ai-doc-go

[![Language](https://img.shields.io/badge/Language-Go-blue)](https://golang.org/)
[![Go Version](https://img.shields.io/github/go-mod/go-version/shouni/git-gemini-reviewer-go)](https://golang.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

# Prototypus AI Doc Go

**Prototypus AI Doc Go (PAID Go)** は、Google Gemini API を使用して、開発ドキュメントや技術記事などの長い文章を、対話形式またはモノローグ形式のナレーションスクリプトに変換するための CLI ツールです。

このツールを使えば、コンテンツクリエイターやチームは、文章の校正や推敲にかかる時間を短縮し、**音声コンテンツ制作の最初の壁**を飛び越えることができます。AIが生成するスクリプトは、**話者（ずんだもん/めたん）や感情**がマークダウンで明確に示されており、音声合成ソフトや声優への指示出しが容易になります。

### 🌸 導入がもたらすポジティブな変化

| メリット | 制作チームへの影響 | 期待される効果 |
| :--- | :--- |:---|
| **コンテンツ制作の劇的なスピードアップ** | **「台本作成」の手間が激減します。** 長文や企画書から、ナレーションに最適な会話形式のスクリプトを即座に生成します。 | 動画制作、e-ラーニング、ポッドキャストなどの**コンテンツ供給量**が大幅に増加します。 |
| **キャラクター性の維持と明確化** | **「誰が、どんなトーンで話すか」が明確になります。** AIがプロンプトに従って話者と感情タグを付与するため、キャラクターの個性が際立つスクリプトが得られます。 | 制作物の**統一されたブランドイメージ**が維持され、音声コンテンツの質が向上します。 |
| **多様な出力と連携** | **「スクリプトの活用方法」を自由に選べます。** 標準出力、ファイル保存、**外部連携APIへの投稿**など、チームのワークフローに合わせた最適な方法でスクリプトを受け取れます。 | **自動で次の工程**（データベース、専用ツールなど） へデータを引き渡すことが可能になります。 |

-----

## ✨ 技術スタック (Technology Stack)

| 要素 | 技術 / ライブラリ | 役割 |
| :--- | :--- | :--- |
| **言語** | **Go (Golang)** | ツールの開発言語。クロスプラットフォームでの高速な実行を実現します。 |
| **並行処理** | **Goroutines (`sync` パッケージ)** | 複数の音声合成リクエストを**並列**で実行し、ネットワーク待ち時間や合成処理にかかる時間を短縮します。 |
| **CLI フレームワーク** | **Cobra** | コマンドライン引数（フラグ）やサブコマンド構造の構築に使用します。 |
| **AI モデル** | **Google Gemini API** | 入力された文章を分析し、指定された形式のナレーションスクリプトを生成するために使用します。 |
| **プロンプト管理** | **`//go:embed`** | プロンプトテンプレートをビルド時に実行ファイル内に埋め込み、管理を容易にします。 |
| **連携サービス** | 標準 `net/http` | 生成されたスクリプトを**任意の外部API**にJSON形式で投稿するために使用します。 |

-----

## 🛡️ VOICEVOX連携の堅牢性

VOICEVOX連携機能は、長文のスクリプトを高速かつ安定して音声化するために、Go言語の強力な機能と緻密なエラーハンドリングを組み合わせています。

### 1\. 超高速な並列処理 (High-Speed Parallel Processing)

長大なスクリプトは数十から数百の\*\*セグメント（短い文）\*\*に分割され、各セグメントの音声合成リクエストは、**GoのGoroutine**を用いて並列に処理されます。

* **技術詳細**:
    * Goroutineを活用し、各セグメントの `audio_query` (音声クエリ) および `synthesis` (合成) API呼び出しを独立して実行します。
    * これにより、ネットワークI/O待ち時間やVOICEVOXエンジン側の処理キュー待機時間を効率的に埋め合わせ、**逐次処理と比較して合成時間を劇的に短縮**します。
    * 合成が完了したWAVデータは、並列処理の完了後、`bytes.Buffer` を介して正確な順番で結合され、単一のファイルとして出力されます。

### 2\. 高安定性のためのリトライ処理 (Reliable Retry Logic)

VOICEVOXエンジンに短時間に大量のリクエストが集中した場合や、一時的なネットワーク負荷増大が発生した場合に備え、堅牢なリトライ機構を実装しています。

* **技術詳細**:
    * 並列実行中にセグメントごとの合成リクエストがタイムアウトやエラー（例：`context deadline exceeded`）を検出した場合、**指数バックオフ（Exponential Backoff）に近い戦略で処理を最大3回自動リトライ**します。
    * これにより、一時的なエンジンの負荷集中による失敗を吸収し、ユーザーが手動で再実行することなく、大規模なスクリプト全体の**音声合成成功率**を極めて高い水準に維持します。
    * リトライ間隔は徐々に延長されるため、エンジンへの更なる過負荷を避ける設計になっています。

### 3\. スタイルIDの自動フォールバック (Automatic Style ID Fallback)

AIモデルの出力形式がプロンプトの指示からわずかに逸脱し、VOICEVOXがサポートしないタグが生成された場合でも、処理を中断させません。

* **技術詳細**:
    * `internal/voicevox` パッケージ内のマッピングロジックにおいて、AIが生成した話者・トーンタグ（例：`[ずんだもん][納得]`）に対応する `Style ID` が見つからない場合、自動でその話者の\*\*デフォルトのトーン（`[話者タグ][通常]`）\*\*の `Style ID` に切り替えます。
    * これにより、AI出力の軽微なフォーマットミス（例：`[ずんだもん][ずんだ]`, `[めたん][驚き]`）によってCLIの処理が中断することを防ぎ、音声ファイルの生成を確実に完了させます。

-----

## ✨ 主な機能

1.  **AIによる自動スクリプト生成**: 長文を **`solo`** (モノローグ)、**`dialogue`** (対話)、**`duet`** (交互ナレーション) の**3つの形式**に変換します。
2.  **VOICEVOX連携（NEW\!）**: 生成されたスクリプトをローカルで起動しているVOICEVOXエンジンに送信し、**ゴルーチンによる並列処理**で高速に合成を行い、**連結された一つのWAV音声ファイル**として出力できます。
3.  **堅牢な処理**: 上記の**リトライ**および**フォールバック**ロジックにより、並列処理環境での安定した音声ファイル生成を実現します。
4.  **柔軟なI/O**: ファイル入力/出力、標準入力/出力、そして外部APIへの投稿に対応しています。
5.  **高い保守性**: Goのベストプラクティスに基づき、AI、I/O、VOICEVOX処理などのロジックが `internal` パッケージに分離されています。

-----

## 📦 使い方

### 1\. 環境設定

ツールを実行する前に、以下の環境変数を設定してください。

| 変数名 | 必須/任意 | 説明 |
| :--- | :--- | :--- |
| `GEMINI_API_KEY` | 必須 | Google AI Studio で取得した Gemini API キー。 |
| `VOICEVOX_API_URL` | VOICEVOX使用時必須 | ローカルで起動しているVOICEVOXエンジンのURL。 (例: `http://localhost:50021`) |
| `POST_API_URL` | 外部API投稿時必須 | スクリプトを投稿する外部APIのエンドポイント。 |

### 2\. スクリプト生成コマンド

メインコマンドは `generate` です。

```bash
prototypus-ai-doc generate [flags]
```

#### フラグ一覧

| フラグ | 短縮形 | 説明 |
| :--- | :--- | :--- |
| `--input-file` | `-i` | 元となる文章ファイル (`.txt` や `.md`) のパス。省略時は標準入力を使用。 |
| `--output-file` | `-o` | 生成されたスクリプトを保存するファイル名。省略時は標準出力に出力。 |
| `--mode` | `-m` | スクリプトの形式: **`solo`** (モノローグ/デフォルト), **`dialogue`** (対話), **`duet`** (交互ナレーション)。**(Default: `solo`)** |
| `--voicevox` | `-v` | **(新機能)** 生成されたスクリプトをVOICEVOXで合成し、指定されたファイル名 (`.wav`) で保存します。**他の出力フラグと同時に指定できません。** |
| `--post-api` | `-p` | 生成されたスクリプトを `POST_API_URL` に投稿します。 |

-----

## 🔊 VOICEVOX連携の実行例

### 目的: この `README.md` を入力として使用し、対話スクリプトを生成、そして音声化する。

まず、この README ファイルを `README.md` として保存されていると仮定します。

#### 1\. VOICEVOXエンジンを起動し、環境変数を設定

```bash
# VOICEVOXを起動後、URLを設定
export VOICEVOX_API_URL="http://localhost:50021"
export GEMINI_API_KEY="AIzaSy...your-key...021"
```

#### 2\. コマンド実行

**入力ファイル (`-i`)** として自身の `README.md` を指定し、**VOICEVOX出力 (`-v`)** を `readme_audio.wav` に指定します。モードのデフォルトは `solo` ですが、例として `duet` を使用します。

```bash
# README.md の内容を元に対話スクリプトを生成し、WAVファイルを出力
./bin/prototypus-ai-doc generate \
    -i README.md \
    -m duet \
    -v readme_audio.wav
```

#### 実行結果 (ターミナル出力)

```
ファイルから読み込み中: README.md
--- 処理開始 ---
モード: duet
モデル: gemini-2.5-flash
...（入力サイズなどの情報）...

AIによるスクリプト生成を開始します...

VOICEVOXエンジンに接続し、音声合成を並列で開始します (出力: readme_audio.wav)...
VOICEVOXによる音声合成が完了し、ファイルに保存されました。

# 現在のディレクトリに readme_audio.wav が生成されます。
```

-----

### 📜 ライセンス (License)

このプロジェクトは [MIT License](https://opensource.org/licenses/MIT) の下で公開されています。